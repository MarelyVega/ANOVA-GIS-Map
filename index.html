<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Congressional Community Distinguishing Characteristics</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.29/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.29/"></script>

  <style>
    :root{
      --bg:#f3efec;
      --navy:#1A2740;
      --navy-2:#1E2F4A;

      --panel-blue: var(--navy);
      --panel-blue-2: var(--navy-2);

      --text-light:#ffffff;
      --text-mid:#cfe0ff;

      --bubble-bg:#7F90B2;
      --border:#e3e3e3;
    }

    html, body { height:100%; margin:0; background: var(--bg); font-family: Avenir Next, Avenir, Helvetica, Arial, sans-serif; }
    #app { height:100%; display:flex; flex-direction:column; }

    .topbar{
      height:72px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      background: #efeae6;
      border-bottom: 1px solid #ddd7d2;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-size:32px; font-weight:300; color:#2a2a2a;
      letter-spacing:0.2px;
    }
    .logo{
      width:46px; height:46px; border-radius:10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid #cfc7c1; background:#f7f3f0;
      font-size:26px;
    }
    .icons{ display:flex; align-items:center; gap:10px; opacity:0.9; }
    .icon{
      width:28px; height:28px; border-radius:50%;
      border:1px solid #d8d1cb; background:#faf7f5;
      display:flex; align-items:center; justify-content:center;
      font-size:14px;
    }

    .tabs{
      padding:12px 18px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:14px;
      background: var(--bg);
    }
    .tab{
      height:40px;
      border-radius:22px;
      border:1px solid #d8d1cb;
      background:#ffffffcc;
      display:flex; align-items:center; justify-content:center;
      font-weight:500;
      color:#2a2a2a;
      user-select:none;
      cursor:pointer;
    }
    .tab.active{
      background: var(--navy);
      border-color: var(--navy);
      color:#fff;
    }

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 400px 1fr 420px;
      gap:18px;
      padding:0 18px 18px 18px;
      min-height:0;
    }

    .leftPanel{
      background: var(--panel-blue);
      border-radius:10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .leftHeader{
      padding:12px 14px;
      background: var(--panel-blue-2);
      color: var(--text-light);
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,0.10);
      font-size:14px;
    }
    .groupRow{
      padding:12px 14px;
      color: var(--text-light);
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size:14px;
    }
    .caret{
      width:0; height:0;
      border-left:8px solid var(--text-light);
      border-top:7px solid transparent;
      border-bottom:7px solid transparent;
      transform: rotate(90deg);
      opacity:0.9;
    }

    .layerList{
      overflow:auto;
      padding:10px 0;
      min-height:0;
    }

    .layerItem{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,0.10);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      cursor:pointer;
      user-select:none;
    }
    .layerItem:hover{ background: rgba(255,255,255,0.08); }
    .layerItem.active{ background: rgba(255,255,255,0.14); }

    .layerText{ min-width:0; }
    .layerTitle{
      color: var(--text-light);
      font-weight:600;
      font-size:14px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 300px;
    }
    .layerDesc{
      margin-top:6px;
      color: var(--text-mid);
      font-size:13px;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }

    .eye{
      flex:0 0 auto;
      width:36px; height:36px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.28);
      background: rgba(0,0,0,0.14);
      display:flex; align-items:center; justify-content:center;
      color: var(--text-light);
      font-size:16px;
      opacity:0.95;
      margin-top:2px;
    }

    .legendWrap{
      border-top:1px solid rgba(255,255,255,0.12);
      padding:10px 12px 12px 12px;
      background: rgba(0,0,0,0.06);
    }
    .legendTitle{
      color: rgba(255,255,255,0.95);
      font-weight:700;
      font-size:13px;
      margin-bottom:8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .legendDiv{
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:10px;
      padding:8px;
      max-height:180px;
      overflow:auto;
    }
    .legendDiv .esri-legend__layer-caption,
    .legendDiv .esri-legend__service-label,
    .legendDiv .esri-legend__layer-table,
    .legendDiv .esri-legend__message{
      color:#fff !important;
    }

    .leftFooter{
      padding:10px 14px;
      border-top:1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.90);
      font-size:12px;
      background: rgba(0,0,0,0.08);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .mapWrap{
      background:#fff;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
      min-height:0;
      position:relative;
    }
    #viewDiv{ height:100%; width:100%; }

    .esri-ui .esri-widget--button.esri-locate{ width:44px !important; height:44px !important; }
    .esri-ui .esri-widget--button.esri-locate span{ font-size:20px !important; }

    .rightPanel{
      background:#ffffff;
      border-radius:10px;
      border:1px solid var(--border);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .rightTop{
      padding:14px 14px 12px 14px;
      border-bottom:1px solid var(--border);
    }
    .rightTop h2{
      margin:0 0 6px 0;
      font-size:20px;
      font-weight:700;
      color:#1f1f1f;
    }
    .rightTop p{
      margin:0;
      font-size:13px;
      line-height:1.35;
      color:#444;
    }
    .rightBody{
      padding:14px;
      overflow:auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .card{
      background: var(--bubble-bg);
      border:1px solid rgba(0,0,0,0.08);
      border-radius:10px;
      padding:12px;
      color:#ffffff;
      font-size:13px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üèõÔ∏è</div>
        <div>Congressional Community Distinguishing Characteristics</div>
      </div>
      <div class="icons">
        <div class="icon">f</div>
        <div class="icon">x</div>
        <div class="icon">üí¨</div>
        <div class="icon">‚§¥</div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-theme="Demographics">Demographics</div>
      <div class="tab" data-theme="Social">Social</div>
      <div class="tab" data-theme="Economic">Economic</div>
      <div class="tab" data-theme="Housing">Housing</div>
    </div>

    <div class="main">
      <div class="leftPanel">
        <div class="leftHeader" id="leftHeader">Demographics</div>

        <div class="groupRow">
          <span class="caret"></span>
          <span id="groupName">Demographics</span>
        </div>

        <div id="layerList" class="layerList"></div>

        <div class="legendWrap">
          <div class="legendTitle" id="legendTitle">Legend</div>
          <div id="legendDiv" class="legendDiv"></div>
        </div>

        <div class="leftFooter" id="hint">Click a community, use Locate Me, or search an address.</div>
      </div>

      <div class="mapWrap">
        <div id="viewDiv"></div>
      </div>

      <div class="rightPanel">
        <div class="rightTop">
          <h2>Explore Community Variation Within Your District</h2>
          <p>Search an address or use Locate Me. Your district/community are highlighted</p>
        </div>

        <div class="rightBody">
          <div class="card" id="infoCard">
            <div id="titleLine" style="font-weight:800; font-size:16px; line-height:1.25;">‚Äî</div>

            <div style="height:10px;"></div>

            <div style="font-weight:700; opacity:0.95;">Higher end outliers</div>
            <div id="higherOutliers" style="margin-top:6px; opacity:0.98;">‚Äî</div>

            <div style="height:10px;"></div>

            <div style="font-weight:700; opacity:0.95;">Lower end outliers</div>
            <div id="lowerOutliers" style="margin-top:6px; opacity:0.98;">‚Äî</div>
          </div>

          <div class="card">
            (Optional) Feature info ACS Census etc can be added in here later
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    require([
      "esri/config",
      "esri/WebMap",
      "esri/views/MapView",
      "esri/widgets/Locate",
      "esri/widgets/Search",
      "esri/widgets/Legend",
      "esri/layers/GraphicsLayer",
      "esri/Graphic"
    ], function (esriConfig, WebMap, MapView, Locate, Search, Legend, GraphicsLayer, Graphic) {

      // Block only premium endpoints you specified
      const BLOCKED_PATTERNS = [
        /route\.arcgis\.com/i,
        /geoenrichment\.arcgis\.com/i,
        /analysis\.arcgis\.com/i,
        /tasks\.arcgis\.com/i,
        /logistics\.arcgis\.com/i,
        /hydro\.arcgis\.com/i
      ];

      esriConfig.request.interceptors.push({
        before: function (params) {
          const url = (params && params.url) ? String(params.url) : "";
          for (const rx of BLOCKED_PATTERNS) {
            if (rx.test(url)) {
              const msg = `Blocked request to premium service (cost lockdown): ${url}`;
              console.error(msg);
              throw new Error(msg);
            }
          }
        }
      });

      const WEBMAP_ID = "225896b53aed4a8c9d518336e8a8ceb4";
      const DISTRICT_TITLE  = "cc20_us_03102025_500k_cd_dissolve";
      const COMMUNITY_TITLE = "Communities";
      const THEMES = ["Demographics", "Social", "Economic", "Housing"];

      // Demo mapping (exact)
      const DEMO_CODE_TO_TITLE = {
        "D018": "Median age (years)",
        "D019": "Under 18 years",
        "D024": "65 years and over",
        "D036": "One Race",
        "D037": "One Race -- White",
        "D039": "One Race -- American Indian and Alaska Native",
        "D055": "One Race -- Native Hawaiian and Other Pacific Islander",
        "D060": "One Race -- Some Other Race",
        "D061": "Two or more races",
        "D076": "Hispanic or Latino (of any race)",
        "D081": "Not Hispanic or Latino",
        "D082": "Not Hispanic or Latino -- White Alone",
        "D083": "Not Hispanic or Latino -- Black or African American Alone",
        "D092": "CVAP Citizen 18 and Over Population"
      };

      // Social mapping (exact)
      const SOCIAL_CODE_TO_TITLE = {
        "S016": "Average Household Size",
        "S017": "Average Family Size",
        "S053": "School Enrollment -- Pop 3 Yrs & Over Enrolled in School",
        "S058": "School Enrollment -- Pop 3 Yrs & Over Enrolled in School -- College or Graduate School",
        "S068": "Educational Attainment -- Pop 25 Yrs & Over -- Percent Bachelor's Degree or Higher",
        "S079": "Residence 1 Year Ago -- Population 1 Year and Over",
        "S080": "Residence 1 Year Ago -- Same House",
        "S086": "Residence 1 Year Ago -- Different House in US -- Different County -- Different State",
        "S087": "Residence 1 Year Ago -- Abroad",
        "S089": "Place of Birth -- Native",
        "S092": "Place of Birth -- Native -- Born in U.S. -- Different State",
        "S153": "Computers and Internet Use -- Households with a Computer",
        "S154": "Computers and Internet Use -- Households with a Broadband Internet Subscription"
      };

      const ECON_CODES = [
        "E002","E003","E004","E005","E006","E007","E008","E009P",
        "E047","E048","E049","E062","E063","E065","E066","E067","E068","E069",
        "E071","E073","E074","E086","E087","E088","E089","E090","E091",
        "E096","E097","E098","E099"
      ];

      const HOUSING_CODES = [
        "H002","H003","H007","H008","H009","H010","H012","H014","H015","H017",
        "H037","H046","H047","H048","H049","H051","H058","H059","H060","H061",
        "H089","H091","H092","H126","H134"
      ];

      function normTitle(s){
        return String(s || "")
          .replace(/\u2013|\u2014/g, "-")
          .replace(/\s+/g, " ")
          .trim()
          .toLowerCase();
      }

      const SOCIAL_TITLE_TO_CODE = (() => {
        const m = new Map();
        for (const [code, title] of Object.entries(SOCIAL_CODE_TO_TITLE)) {
          m.set(normTitle(title), code);
        }
        return m;
      })();

      const DEMO_TITLE_TO_CODE = (() => {
        const m = new Map();
        for (const [code, title] of Object.entries(DEMO_CODE_TO_TITLE)) {
          m.set(normTitle(title), code);
        }
        return m;
      })();

      const tabsEl = document.getElementById("tabs");
      const leftHeaderEl = document.getElementById("leftHeader");
      const layerListEl = document.getElementById("layerList");
      const groupNameEl = document.getElementById("groupName");
      const hintEl = document.getElementById("hint");
      const setHint = (msg) => { hintEl.textContent = msg; };

      const titleLineEl = document.getElementById("titleLine");
      const higherOutliersEl = document.getElementById("higherOutliers");
      const lowerOutliersEl  = document.getElementById("lowerOutliers");

      const legendTitleEl = document.getElementById("legendTitle");
      const legendDivEl = document.getElementById("legendDiv");
      let legendWidget = null;

      function possessive(name){
        const s = String(name || "").trim();
        if (!s) return "";
        return /s$/i.test(s) ? `${s}'` : `${s}'s`;
      }

      function normalizeMultilineList(v) {
        const raw = String(v ?? "").replace(/\r\n/g, "\n").trim();
        if (!raw) return [];
        return raw.split("\n").map(s => s.trim()).filter(Boolean);
      }

      function renderBullets(el, items) {
        if (!items.length) { el.textContent = "‚Äî"; return; }
        el.innerHTML =
          "<ul style='margin:6px 0 0 18px; padding:0;'>" +
          items.map(x => `<li style="margin:4px 0;">${x}</li>`).join("") +
          "</ul>";
      }

      function showLegendForLayer(layer, titleText){
        if (!layer) {
          legendTitleEl.textContent = "Legend";
          legendDivEl.innerHTML = "<div style='color:#fff;opacity:.9;font-size:12px;'>Select a layer to view its legend.</div>";
          if (legendWidget) legendWidget.layerInfos = [];
          return;
        }

        legendTitleEl.textContent = titleText || (layer.title || "Legend");

        if (!legendWidget) {
          legendWidget = new Legend({
            view,
            container: legendDivEl,
            layerInfos: [{ layer, title: "" }]
          });
        } else {
          legendWidget.layerInfos = [{ layer, title: "" }];
        }
      }

      function escapeSqlString(v) { return String(v).replace(/'/g, "''"); }
      function isNumericFieldType(t) { return ["double","single","integer","small-integer"].includes(String(t || "").toLowerCase()); }
      function extractFirstInt(v) { const m = String(v ?? "").match(/-?\d+/); return m ? parseInt(m[0], 10) : null; }

      function stripHtml(s) {
        return String(s || "")
          .replace(/<style[\s\S]*?<\/style>/gi, "")
          .replace(/<script[\s\S]*?<\/script>/gi, "")
          .replace(/<[^>]*>/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      function eyeGlyph(isOn){ return isOn ? "üëÅ" : "‚óå"; }

      function fieldNameCI(layer, name) {
        const f = (layer.fields || []).find(x => String(x.name).toLowerCase() === String(name).toLowerCase());
        return f ? f.name : null;
      }

      function getAttrCI(attrs, candidates) {
        if (!attrs) return null;
        const map = new Map(Object.keys(attrs).map(k => [String(k).toLowerCase(), k]));
        for (const c of candidates) {
          const hit = map.get(String(c).toLowerCase());
          if (hit) return attrs[hit];
        }
        return null;
      }

      function flattenGroupFeatureLayersPreserveOrder(group) {
        const out = [];
        function walk(g) {
          g.layers.forEach((lyr) => {
            if (lyr.type === "group") walk(lyr);
            else if (lyr.type === "feature") out.push(lyr);
          });
        }
        walk(group);
        return out;
      }

      async function detectZFieldByCodes(layer, codes) {
        await layer.load();
        const set = new Set((layer.fields || []).map(f => String(f.name).toLowerCase()));
        for (const code of codes) {
          const z = `${code}Z`;
          if (set.has(z.toLowerCase())) return z;
        }
        return null;
      }

      async function getZFieldForLayer(theme, layer) {
        await layer.load();

        if (theme === "Social") {
          const t = normTitle(layer.title || "");
          const code = SOCIAL_TITLE_TO_CODE.get(t);
          return code ? `${code}Z` : null;
        }

        if (theme === "Demographics") {
          const t = normTitle(layer.title || "");
          const code = DEMO_TITLE_TO_CODE.get(t);
          return code ? `${code}Z` : null;
        }

        if (theme === "Economic") {
          return await detectZFieldByCodes(layer, ECON_CODES);
        }

        if (theme === "Housing") {
          return await detectZFieldByCodes(layer, HOUSING_CODES);
        }

        return null;
      }

      // Outlier source layer (per theme) where HIGHER_END / LOWER_END_ exist
      let outlierSourceLayerByTheme = {
        Demographics: null,
        Social: null,
        Economic: null,
        Housing: null
      };

      async function setOutlierSourceLayerForTheme(theme, group) {
        outlierSourceLayerByTheme[theme] = null;
        const kids = flattenGroupFeatureLayersPreserveOrder(group);

        for (const lyr of kids) {
          if (lyr.type !== "feature") continue;
          try { await lyr.load(); } catch { continue; }

          const hi = fieldNameCI(lyr, "HIGHER_END") || fieldNameCI(lyr, "Higher_end") || fieldNameCI(lyr, "Higher_end");
          const lo = fieldNameCI(lyr, "LOWER_END_") || fieldNameCI(lyr, "Lower_end_") || fieldNameCI(lyr, "LOWER_END");

          if (hi && lo) {
            outlierSourceLayerByTheme[theme] = lyr;
            return;
          }
        }
      }

      async function fetchThemeOutliers(theme, selectedCommunityFeature) {
        const src = outlierSourceLayerByTheme[theme];
        if (!src) return { higher: [], lower: [] };

        const ccn20 = getAttrCI(selectedCommunityFeature.attributes, ["CCN20"]);
        if (ccn20 === null || ccn20 === undefined || String(ccn20).trim() === "") {
          return { higher: [], lower: [] };
        }

        const ccnField = fieldNameCI(src, "CCN20");
        if (!ccnField) return { higher: [], lower: [] };

        const where = `${ccnField} = '${escapeSqlString(String(ccn20).trim())}'`;

        const q = src.createQuery();
        q.where = where;
        q.outFields = ["*"];
        q.returnGeometry = false;

        const res = await src.queryFeatures(q);
        const feat = res.features && res.features[0];
        if (!feat) return { higher: [], lower: [] };

        const a = feat.attributes || {};

        const higherRaw = getAttrCI(a, ["HIGHER_END", "Higher_end"]);
        const lowerRaw  = getAttrCI(a, ["LOWER_END_", "Lower_end_", "LOWER_END"]);

        return {
          higher: normalizeMultilineList(higherRaw),
          lower:  normalizeMultilineList(lowerRaw)
        };
      }

      const webmap = new WebMap({ portalItem: { id: WEBMAP_ID } });

      const view = new MapView({
        container: "viewDiv",
        map: webmap
      });

      const locate = new Locate({ view });
      view.ui.add(locate, "top-left");

      const search = new Search({ view, popupEnabled: false });
      view.ui.add(search, "top-right");

      const markerLayer = new GraphicsLayer({ listMode: "hide" });
      webmap.add(markerLayer);

      const markerSymbol = {
        type: "simple-marker",
        style: "circle",
        size: 18,
        color: [0, 122, 194, 0.95],
        outline: { color: [255, 255, 255, 1], width: 2 }
      };

      function setMarker(point) {
        markerLayer.removeAll();
        markerLayer.add(new Graphic({ geometry: point, symbol: markerSymbol }));
      }

      let districtLayer;
      let communityLayer;

      const themeGroups = { Demographics:null, Social:null, Economic:null, Housing:null };
      let activeTheme = "Demographics";
      let groupLayer = null;
      let variableLayers = [];

      let districtHL = null;
      let communityHL = null;

      let token = 0;

      let currentSelection = { districtFeature: null, communityFeature: null };

      async function polygonFromPoint(layer, point) {
        const q = layer.createQuery();
        q.geometry = point;
        q.spatialRelationship = "intersects";
        q.returnGeometry = true;
        q.outFields = ["*"];
        const res = await layer.queryFeatures(q);
        return res.features[0] || null;
      }

      async function clearHighlights() {
        if (districtHL) { districtHL.remove(); districtHL = null; }
        if (communityHL) { communityHL.remove(); communityHL = null; }
      }

      async function highlightOnly(districtFeature, communityFeature) {
        await clearHighlights();
        const dView = await view.whenLayerView(districtLayer);
        const cView = await view.whenLayerView(communityLayer);
        districtHL = dView.highlight([districtFeature.attributes[districtLayer.objectIdField]]);
        communityHL = cView.highlight([communityFeature.attributes[communityLayer.objectIdField]]);
      }

      async function setRightPanelFromCommunity(communityFeature) {
        const a = communityFeature?.attributes || {};

        const state = String(a["STATENAME"] ?? a["StateName"] ?? "").trim();
        const dist  = String(a["DISTRICTOR"] ?? a["DistrictOr"] ?? "").trim();
        const comm  = String(a["COMMUNITY"] ?? a["Community"] ?? "").trim();

        titleLineEl.textContent = `${possessive(state)} ${dist} District Community ${comm}`.trim();

        const out = await fetchThemeOutliers(activeTheme, communityFeature);
        renderBullets(higherOutliersEl, out.higher);
        renderBullets(lowerOutliersEl, out.lower);
      }

      function renderLayerList(items) {
        layerListEl.innerHTML = "";

        if (!items.length) {
          const empty = document.createElement("div");
          empty.style.padding = "12px 14px";
          empty.style.color = "rgba(255,255,255,0.90)";
          empty.style.fontSize = "13px";
          empty.textContent = "No outlier layers (¬±2) found in this district for this tab.";
          layerListEl.appendChild(empty);

          showLegendForLayer(null);
          return;
        }

        items.forEach((it, idx) => {
          const row = document.createElement("div");
          row.className = "layerItem";

          const left = document.createElement("div");
          left.className = "layerText";

          const title = document.createElement("div");
          title.className = "layerTitle";
          title.textContent = it.title;
          left.appendChild(title);

          if (it.desc) {
            const desc = document.createElement("div");
            desc.className = "layerDesc";
            desc.textContent = it.desc;
            left.appendChild(desc);
          }

          const eye = document.createElement("div");
          eye.className = "eye";
          eye.textContent = eyeGlyph(false);

          row.appendChild(left);
          row.appendChild(eye);

          const setActive = () => {
            variableLayers.forEach(l => { l.visible = false; });
            it.layer.visible = true;

            [...layerListEl.querySelectorAll(".layerItem")].forEach(n => n.classList.remove("active"));
            row.classList.add("active");

            [...layerListEl.querySelectorAll(".eye")].forEach(e => e.textContent = eyeGlyph(false));
            eye.textContent = eyeGlyph(true);

            showLegendForLayer(it.layer, it.title);
          };

          row.addEventListener("click", setActive);
          eye.addEventListener("click", (ev) => { ev.stopPropagation(); setActive(); });

          layerListEl.appendChild(row);

          if (idx === 0) setTimeout(setActive, 0);
        });
      }

      async function updateListForSelectedDistrictOutliers(selectedCommunityFeature, myToken) {
        variableLayers.forEach(l => { l.visible = false; });

        const attrs = selectedCommunityFeature?.attributes || {};
        const districtKeyRaw = attrs["DISTRICTOR"] ?? attrs["DistrictOr"];

        if (districtKeyRaw === null || districtKeyRaw === undefined || String(districtKeyRaw).trim() === "") {
          renderLayerList([]);
          setHint("District key missing on selected community.");
          return;
        }

        const shown = [];

        for (const lyr of variableLayers) {
          if (myToken !== token) return;

          try { await lyr.load(); } catch { continue; }

          const districtFieldObj = (lyr.fields || []).find(f => ["districtoR","districtor"].includes(String(f.name).toLowerCase()));
          if (!districtFieldObj) continue;

          const zField = await getZFieldForLayer(activeTheme, lyr);
          if (!zField) continue;

          const zFieldObj = (lyr.fields || []).find(f => String(f.name).toLowerCase() === String(zField).toLowerCase());
          if (!zFieldObj) continue;

          const districtField = districtFieldObj.name;
          const districtIsNumeric = isNumericFieldType(districtFieldObj.type);

          let districtWhere;
          if (districtIsNumeric) {
            const dNum = extractFirstInt(districtKeyRaw);
            if (dNum === null || !Number.isFinite(dNum)) continue;
            districtWhere = `${districtField} = ${dNum}`;
          } else {
            const dEsc = escapeSqlString(String(districtKeyRaw).trim());
            districtWhere = `${districtField} = '${dEsc}'`;
          }

          const where = `(${districtWhere}) AND ((${zField} >= 2) OR (${zField} <= -2))`;

          let count = 0;
          try {
            count = await lyr.queryFeatureCount({ where });
          } catch (e) {
            console.warn("queryFeatureCount failed:", lyr.title, e);
            continue;
          }

          if (myToken !== token) return;

          if (count > 0) {
            const desc = stripHtml(lyr.description || "");
            shown.push({ layer: lyr, title: lyr.title, desc });
          }
        }

        renderLayerList(shown);
        setHint(`District: ${districtKeyRaw} | Outlier layers: ${shown.length}`);
      }

      function setActiveThemeUI(theme) {
        [...tabsEl.querySelectorAll(".tab")].forEach(t => {
          t.classList.toggle("active", t.dataset.theme === theme);
        });
      }

      async function setActiveTheme(theme) {
        const grp = themeGroups[theme];
        if (!grp) return;

        activeTheme = theme;
        setActiveThemeUI(theme);

        Object.keys(themeGroups).forEach(k => {
          if (themeGroups[k]) themeGroups[k].visible = (k === theme);
        });

        groupLayer = grp;
        await setOutlierSourceLayerForTheme(theme, grp);

        groupNameEl.textContent = grp.title || theme;
        leftHeaderEl.textContent = theme;

        const kids = flattenGroupFeatureLayersPreserveOrder(grp);
        variableLayers = kids.filter(l => l.type === "feature");
        variableLayers.forEach(l => { l.visible = false; });

        token++;
        const myToken = token;

        if (currentSelection?.communityFeature) {
          await setRightPanelFromCommunity(currentSelection.communityFeature);
          await updateListForSelectedDistrictOutliers(currentSelection.communityFeature, myToken);
        } else {
          renderLayerList([]);
          showLegendForLayer(null);
          setHint("Click a community, use Locate Me, or search an address.");
        }
      }

      async function applySelection(point) {
        token++;
        const myToken = token;

        setMarker(point);

        const communityFeature = await polygonFromPoint(communityLayer, point);
        const districtFeature  = await polygonFromPoint(districtLayer, point);

        if (myToken !== token) return;

        if (!communityFeature || !districtFeature) {
          setHint("No community/district found at that location.");
          return;
        }

        currentSelection.communityFeature = communityFeature;
        currentSelection.districtFeature = districtFeature;

        await setRightPanelFromCommunity(communityFeature);
        await highlightOnly(districtFeature, communityFeature);

        const ext = districtFeature.geometry?.extent;
        if (ext) await view.goTo(ext.expand(1.08));
        else await view.goTo(districtFeature.geometry);

        await updateListForSelectedDistrictOutliers(communityFeature, myToken);
      }

      view.when(async () => {
        districtLayer  = webmap.allLayers.find(l => l.type === "feature" && l.title === DISTRICT_TITLE);
        communityLayer = webmap.allLayers.find(l => l.type === "feature" && l.title === COMMUNITY_TITLE);

        if (!districtLayer || !communityLayer) {
          console.error("Required layers not found. Printing allLayers:");
          webmap.allLayers.forEach((l, i) => console.log(i, l.title, l.type, l.url));
          setHint("Layer setup error (see console).");
          return;
        }

        const groups = webmap.allLayers.filter(l => l.type === "group");
        const byTitleExact = (name) => groups.find(g => String(g.title || "").trim() === name) || null;

        themeGroups.Demographics = byTitleExact("Demographics");
        themeGroups.Social       = byTitleExact("Social");
        themeGroups.Economic     = byTitleExact("Economic");
        themeGroups.Housing      = byTitleExact("Housing");

        const missing = Object.keys(themeGroups).filter(k => !themeGroups[k]);
        if (missing.length) {
          console.error("Missing group layers:", missing);
          console.log("Found group layers:", groups.map(g => g.title));
          setHint("Group layer setup error (see console).");
          return;
        }

        tabsEl.addEventListener("click", async (ev) => {
          const tab = ev.target.closest(".tab");
          if (!tab) return;
          const theme = tab.dataset.theme;
          if (!THEMES.includes(theme)) return;
          await setActiveTheme(theme);
        });

        view.on("click", async (evt) => {
          try { await applySelection(evt.mapPoint); }
          catch (e) { console.error("Click selection error:", e); }
        });

        locate.on("locate", async (e) => {
          try {
            const point = {
              type: "point",
              longitude: e.position.coords.longitude,
              latitude: e.position.coords.latitude,
              spatialReference: { wkid: 4326 }
            };
            await applySelection(point);
          } catch (err) {
            console.error("Locate error:", err);
          }
        });

        search.on("select-result", async (evt) => {
          try {
            const geom = evt?.result?.feature?.geometry;
            if (geom) await applySelection(geom);
          } catch (err) {
            console.error("Search select-result error:", err);
          }
        });

        showLegendForLayer(null);
        await setActiveTheme(activeTheme);
        setHint("Click a community, use Locate Me, or search an address.");
      });

    });
  </script>
</body>
</html>
